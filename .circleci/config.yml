version: 2.1
orbs:
  node: circleci/node@5.0.0

jobs:
  build_and_test_frontend:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      - node/with-cache:
          steps:
            - run: cd frontend && npm ci
            - run: cd frontend && if npm run | grep -q "test"; then npm test || true; else echo "No frontend tests"; fi

  build_and_test_backend:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      - node/with-cache:
          steps:
            - run: cd backend && npm ci || npm install
            - run: cd backend && if npm run | grep -q "test"; then npm test || true; else echo "No backend tests"; fi

  build_and_push_images:
    machine: true
    steps:
      - checkout
      - run: |
          echo "Logging into Docker Hub"
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: |
          docker build -t $DOCKERHUB_USERNAME/ecommerce-frontend:latest ./frontend
          docker build -t $DOCKERHUB_USERNAME/ecommerce-backend:latest ./backend
          docker push $DOCKERHUB_USERNAME/ecommerce-frontend:latest
          docker push $DOCKERHUB_USERNAME/ecommerce-backend:latest

workflows:
  build_and_test_and_push:
    jobs:
      - build_and_test_frontend
      - build_and_test_backend
      - build_and_push_images:
          requires:
            - build_and_test_frontend
            - build_and_test_backend
